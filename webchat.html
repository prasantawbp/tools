<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat + Calls (Firebase)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white flex flex-col h-screen">

  <!-- Header -->
  <header class="bg-gray-800 p-4 flex justify-between items-center shadow">
    <h1 class="text-xl font-bold">Chat + Calls</h1>
    <div id="authSection" class="space-x-2">
      <input id="email" type="email" placeholder="Email" class="px-2 py-1 rounded text-black"/>
      <input id="password" type="password" placeholder="Password" class="px-2 py-1 rounded text-black"/>
      <button id="signupBtn" class="bg-green-500 px-3 py-1 rounded">Sign Up</button>
      <button id="loginBtn" class="bg-blue-500 px-3 py-1 rounded">Login</button>
      <button id="logoutBtn" class="bg-red-500 px-3 py-1 rounded hidden">Logout</button>
    </div>
  </header>

  <!-- Main Layout -->
  <main class="flex-1 flex">
    <!-- Chat Section -->
    <section class="flex-1 flex flex-col border-r border-gray-700">
      <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-950"></div>
      <div class="p-2 flex bg-gray-800">
        <input id="msgInput" placeholder="Type a message" class="flex-1 px-3 py-2 rounded text-black" disabled/>
        <button id="sendBtn" class="bg-blue-600 px-4 ml-2 rounded" disabled>Send</button>
      </div>
    </section>

    <!-- Video Call Section -->
    <section class="w-1/2 flex flex-col items-center p-4 space-y-2">
      <div class="flex space-x-2">
        <input id="roomId" placeholder="Room ID" class="px-2 py-1 rounded text-black"/>
        <button id="copyRoom" class="bg-gray-600 px-3 py-1 rounded">Copy</button>
      </div>
      <div class="space-x-2">
        <button id="createCall" class="bg-green-600 px-4 py-1 rounded" disabled>Create Call</button>
        <input id="answerRoomId" placeholder="Enter Room ID" class="px-2 py-1 rounded text-black"/>
        <button id="answerCall" class="bg-blue-600 px-4 py-1 rounded" disabled>Answer</button>
        <button id="hangup" class="bg-red-600 px-4 py-1 rounded" disabled>Hang Up</button>
      </div>
      <div class="flex space-x-4 w-full justify-center">
        <video id="localVideo" class="w-1/2 rounded bg-black" autoplay playsinline muted></video>
        <video id="remoteVideo" class="w-1/2 rounded bg-black" autoplay playsinline></video>
      </div>
    </section>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // ====== Firebase Config (Replace with your own) ======
   // Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyAbDUvGSBhVj-YIDVF4Bod2eYNx2uaox_Q",
  authDomain: "helpsomeones-4a08a.firebaseapp.com",
  databaseURL: "https://helpsomeones-4a08a-default-rtdb.firebaseio.com",
  projectId: "helpsomeones-4a08a",
  storageBucket: "helpsomeones-4a08a.firebasestorage.app",
  messagingSenderId: "871091320832",
  appId: "1:871091320832:web:918e4e2f9697788010c0e5"
};
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM Elements
    const signupBtn=document.getElementById("signupBtn");
    const loginBtn=document.getElementById("loginBtn");
    const logoutBtn=document.getElementById("logoutBtn");
    const msgInput=document.getElementById("msgInput");
    const sendBtn=document.getElementById("sendBtn");
    const messages=document.getElementById("messages");
    const emailInput=document.getElementById("email");
    const passwordInput=document.getElementById("password");

    let me=null,currentRoom=null,unsubscribe=null;

    // Auth Handlers
    signupBtn.onclick=()=>auth.createUserWithEmailAndPassword(emailInput.value,passwordInput.value)
      .catch(err=>alert(err.message));
    loginBtn.onclick=()=>auth.signInWithEmailAndPassword(emailInput.value,passwordInput.value)
      .catch(err=>alert(err.message));
    logoutBtn.onclick=()=>auth.signOut();

    auth.onAuthStateChanged(user=>{
      me=user;
      if(user){
        logoutBtn.classList.remove("hidden");
        signupBtn.classList.add("hidden");
        loginBtn.classList.add("hidden");
        msgInput.disabled=sendBtn.disabled=false;
        document.getElementById("createCall").disabled=false;
        document.getElementById("answerCall").disabled=false;
        document.getElementById("hangup").disabled=false;
        subscribeChat("default-room");
      }else{
        logoutBtn.classList.add("hidden");
        signupBtn.classList.remove("hidden");
        loginBtn.classList.remove("hidden");
        msgInput.disabled=sendBtn.disabled=true;
      }
    });

    // Chat
    function subscribeChat(room){
      if(unsubscribe)unsubscribe();
      messages.innerHTML="";
      unsubscribe=db.collection("rooms").doc(room).collection("messages")
        .orderBy("createdAt").onSnapshot(s=>{
          messages.innerHTML="";
          s.forEach(doc=>{
            const m=doc.data();
            const div=document.createElement("div");
            div.className="p-2 rounded "+(m.uid===me.uid?"bg-blue-700 ml-auto":"bg-gray-700 mr-auto")+" max-w-xs";
            div.textContent=m.sender+": "+m.text;
            messages.appendChild(div);
          });
        });
      currentRoom=room;
    }

    sendBtn.onclick=()=>{
      if(!msgInput.value)return;
      db.collection("rooms").doc(currentRoom).collection("messages").add({
        text:msgInput.value,
        uid:me.uid,
        sender:me.email,
        createdAt:firebase.firestore.FieldValue.serverTimestamp()
      });
      msgInput.value="";
    };

    // WebRTC Calls
    const servers={iceServers:[{urls:["stun:stun.l.google.com:19302"]}]};
    let pc,localStream,remoteStream,roomRef;

    async function openMedia(){
      if(localStream)return;
      localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
      document.getElementById("localVideo").srcObject=localStream;
      remoteStream=new MediaStream();
      document.getElementById("remoteVideo").srcObject=remoteStream;
    }
    function createPeer(){
      pc=new RTCPeerConnection(servers);
      localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
      pc.ontrack=e=>e.streams[0].getTracks().forEach(t=>remoteStream.addTrack(t));
      pc.onicecandidate=e=>{
        if(e.candidate){
          roomRef.collection(pc.localDescription.type==='offer'?'callerCandidates':'calleeCandidates')
                 .add(e.candidate.toJSON());
        }
      };
    }
    async function createCall(){
      await openMedia();
      roomRef=db.collection("rooms").doc((Math.random()*1e8).toFixed(0));
      createPeer();
      const offer=await pc.createOffer();await pc.setLocalDescription(offer);
      await roomRef.set({offer});
      roomRef.onSnapshot(async snap=>{
        const data=snap.data();
        if(data?.answer && !pc.currentRemoteDescription){
          await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
        }
      });
      roomRef.collection("calleeCandidates").onSnapshot(s=>s.docChanges()
        .forEach(c=>pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))));
      alert("Share this Room ID: "+roomRef.id);
    }
    async function answerCall(){
      await openMedia();
      const id=document.getElementById("answerRoomId").value.trim();
      roomRef=db.collection("rooms").doc(id);
      const snap=await roomRef.get();
      if(!snap.exists)return alert("Room not found");
      createPeer();
      await pc.setRemoteDescription(new RTCSessionDescription(snap.data().offer));
      const answer=await pc.createAnswer();await pc.setLocalDescription(answer);
      await roomRef.update({answer});
      roomRef.collection("callerCandidates").onSnapshot(s=>s.docChanges()
        .forEach(c=>pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))));
    }
    function hangup(){
      if(pc)pc.close();
      pc=null;localStream=null;remoteStream=null;
      document.getElementById("localVideo").srcObject=null;
      document.getElementById("remoteVideo").srcObject=null;
    }

    document.getElementById("createCall").onclick=createCall;
    document.getElementById("answerCall").onclick=answerCall;
    document.getElementById("hangup").onclick=hangup;
    document.getElementById("copyRoom").onclick=()=>navigator.clipboard.writeText(currentRoom||"");
  </script>
</body>
</html>
